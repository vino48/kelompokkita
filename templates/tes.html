<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Keamanan Lingkungan</title>

    <!-- Minified & Defered CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.min.css" defer>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars/styles/overlayscrollbars.min.css" defer>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/adminlte.min.css') }}" />

    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/apexcharts/dist/apexcharts.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/overlayscrollbars/browser/overlayscrollbars.browser.es6.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">GAS</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-3 col-6">
                <!--begin::Small Box Widget 1-->
                <div class="small-box text-bg-secondary" id="gasBox">
                  <div class="inner">
                    <h3><span id="gas">GAS</span></h3>
                    <p>ppm</p>
                  </div>
                  <svg
                    class="small-box-icon"
                    fill="currentColor"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
                  >
                    <path
                      d="M2.25 2.25a.75.75 0 000 1.5h1.386c.17 0 .318.114.362.278l2.558 9.592a3.752 3.752 0 00-2.806 3.63c0 .414.336.75.75.75h15.75a.75.75 0 000-1.5H5.378A2.25 2.25 0 017.5 15h11.218a.75.75 0 00.674-.421 60.358 60.358 0 002.96-7.228.75.75 0 00-.525-.965A60.864 60.864 0 005.68 4.509l-.232-.867A1.875 1.875 0 003.636 2.25H2.25zM3.75 20.25a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zM16.5 20.25a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0z"
                    ></path>
                  </svg>
                  <a
                    href="#"
                    class="small-box-footer link-light link-underline-opacity-0 link-underline-opacity-50-hover"
                  >
                  <span id="gas-alarm">OFF</span>
                  </a>
                </div>

                
                <!--end::Small Box Widget 1-->
              </div>

              <div class="col-lg-3 col-6">
                <!--begin::Small Box Widget 1-->
                <div class="small-box text-bg-secondary" id="smokeBox">
                  <div class="inner">
                    <h3><span id="smoke">ASAP</span></h3>
                    <p></p>
                  </div>
                  <svg
                    class="small-box-icon"
                    fill="currentColor"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
                  >
                    <path
                      d="M2.25 2.25a.75.75 0 000 1.5h1.386c.17 0 .318.114.362.278l2.558 9.592a3.752 3.752 0 00-2.806 3.63c0 .414.336.75.75.75h15.75a.75.75 0 000-1.5H5.378A2.25 2.25 0 017.5 15h11.218a.75.75 0 00.674-.421 60.358 60.358 0 002.96-7.228.75.75 0 00-.525-.965A60.864 60.864 0 005.68 4.509l-.232-.867A1.875 1.875 0 003.636 2.25H2.25zM3.75 20.25a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zM16.5 20.25a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0z"
                    ></path>
                  </svg>
                  <a
                    href="#"
                    class="small-box-footer link-light link-underline-opacity-0 link-underline-opacity-50-hover"
                  >
                  <span id="smoke-alarm">OFF</span>
                  </a>
                </div>

                
                <!--end::Small Box Widget 1-->
              </div>

              <div class="col-lg-3 col-6">
                <!--begin::Small Box Widget 1-->
                <div class="small-box text-bg-secondary" id="tempBox">
                  <div class="inner">
                    <h3><span id="temp">SUHU</span></h3>
                    <p></p>
                  </div>
                  <svg
                    class="small-box-icon"
                    fill="currentColor"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
                  >
                    <path
                      d="M2.25 2.25a.75.75 0 000 1.5h1.386c.17 0 .318.114.362.278l2.558 9.592a3.752 3.752 0 00-2.806 3.63c0 .414.336.75.75.75h15.75a.75.75 0 000-1.5H5.378A2.25 2.25 0 017.5 15h11.218a.75.75 0 00.674-.421 60.358 60.358 0 002.96-7.228.75.75 0 00-.525-.965A60.864 60.864 0 005.68 4.509l-.232-.867A1.875 1.875 0 003.636 2.25H2.25zM3.75 20.25a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zM16.5 20.25a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0z"
                    ></path>
                  </svg>
                  <a
                    href="#"
                    class="small-box-footer link-light link-underline-opacity-0 link-underline-opacity-50-hover"
                  >
                  <span id="temp-alarm">OFF</span>
                  </a>
                </div>

                
                <!--end::Small Box Widget 1-->
              </div>
        </div>    
    </div>
    <div class="container mt-4">
        
        <div class="status">
            <h2>Kontrol Alarm</h2>
            <div class="col-lg-4 col-md-3">
                <p> <button class="btn btn-sm btn-primary float-start" onclick="setAlarm('gas')">ON/OFF</button></p>
            </div>
            <div class="col-lg-4 col-md-3">
                <p> <button class="btn btn-sm btn-primary float-start" onclick="setAlarm('smoke')">ON/OFF</button></p>
            </div>
            <div class="col-lg-4 col-md-6">
                <p> <button class="btn btn-sm btn-primary float-start" onclick="setAlarm('temp')">ON/OFF</button></p>
            </div>
            
            
            
        </div>
    </div>


    

    <footer class="text-center mt-5 py-3 bg-light">
        <strong>Copyright &copy; <span id="year"></span> Keamanan Lingkungan.</strong>
    </footer>

    <script>
        document.getElementById("year").innerText = new Date().getFullYear();

        async function fetchData() {
            try {
                const response = await fetch("/data");
                if (!response.ok) throw new Error("Gagal mengambil data");
                const data = await response.json();
                document.getElementById("gas").innerText = data.gas || "N/A";
                document.getElementById("smoke").innerText = data.smoke || "N/A";
                document.getElementById("temp").innerText = data.temp || "N/A";
                updateBoxes();
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        function updateBoxes() {
            updateBox("gas", "gasBox");
            updateBox("smoke", "smokeBox");
            updateBox("temp", "tempBox");
        }

        function updateBox(id, boxId) {
            let value = document.getElementById(id).innerText;
            let box = document.getElementById(boxId);

            if (!value || value === "GAGAL") {
                box.className = "small-box bg-secondary";
            } else {
                let number = parseFloat(value);
                box.className = number > 13000 ? "small-box bg-danger" : "small-box bg-success";
            }
        }

        setInterval(fetchData, 3000);
    </script>

<script>
    async function fetchData() {
        const response = await fetch('/data');
        const data = await response.json();

        document.getElementById('gas-alarm').innerText = data.gas_status;
        document.getElementById('smoke-alarm').innerText = data.smoke_status;
        document.getElementById('temp-alarm').innerText = data.temp > 30 ? 'Berbahaya' : 'Aman';
        document.getElementById('humidity-alarm').innerText = data.humidity > 70 ? 'Berbahaya' : 'Aman';
    }

    async function setAlarm(type) {
        const status = document.getElementById(`${type}-alarm`).innerText === "OFF" ? "ON" : "OFF";
        await fetch('/set_alarm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type, status })
        });
        fetchData();
    }

    setInterval(fetchData, 2000);
</script>
</body>
</html>